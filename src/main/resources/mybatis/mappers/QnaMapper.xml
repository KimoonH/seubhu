<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.seub2hu2.mypage.mapper.QnaMapper">

    <resultMap id="QnaCategoryMap" type="store.seub2hu2.mypage.dto.QnaCategory">
        <result property="categoryNo" column="CATEGORY_NO"/>
        <result property="categoryName" column="CATEGORY_NAME"/>
    </resultMap>

    <resultMap id="QnaResponseMap" type="store.seub2hu2.mypage.dto.QnaResponse">
        <result property="qnaNo" column="QNA_NO"/>
        <result property="qnaTitle" column="QNA_TITLE"/>
        <result property="qnaContent" column="QNA_CONTENT"/>
        <result property="qnaStatus" column="QNA_STATUS" typeHandler="store.seub2hu2.handler.QnaStatusTypeHandler"/>
        <result property="answerContent" column="ANSWER_CONTENT"/>
        <result property="answerCreatedDate" column="ANSWER_CREATED_DATE"/>
        <result property="qnaCreatedDate" column="QNA_CREATED_DATE"/>
        <result property="qnaUpdatedDate" column="QNA_UPDATED_DATE"/>
        <result property="qnaAnswerdDate" column="QNA_ANSWERD_DATE"/>
        <result property="qnaIsDeleted" column="QNA_ISDELETED"/>
        <result property="questionUserNo" column="QUESTION_USER_NO"/>
        <result property="categoryNo" column="CATEGORY_NO"/>
        <result property="answerUserNo" column="ANSWER_USER_NO"/>
        
        <association property="qnaCategory" resultMap="QnaCategoryMap"/>
    </resultMap>

    <!-- List<QnaResponse> getQnasByUserNo(@Param("userNo") int userNo); -->

    <select id="getQnasByUserNo" resultMap="QnaResponseMap">
        SELECT
            q.QNA_NO, q.QNA_TITLE, q.QNA_CONTENT, q.QNA_STATUS,
            q.ANSWER_CONTENT, q.ANSWER_CREATED_DATE, q.QNA_CREATED_DATE,
            q.QNA_UPDATED_DATE, q.QNA_ANSWERD_DATE, q.QNA_ISDELETED,
            q.QUESTION_USER_NO, q.ANSWER_USER_NO, q.CATEGORY_NO,
            c.CATEGORY_NO AS CATEGORY_NO, c.CATEGORY_NAME
        FROM
            USER_QNA q
                INNER JOIN
            QNA_CATEGORY c ON q.CATEGORY_NO = c.CATEGORY_NO
        WHERE
            q.QNA_ISDELETED = 'N'
        AND
            q.QUESTION_USER_NO = #{userNo}
    </select>

    <!-- QnaResponse getQnaByQnaNo(@Param("qnaNo") int qnaNo); -->

    <select id="getQnaByQnaNo" resultMap="QnaResponseMap">
        SELECT
            q.qna_no,
            q.qna_title,
            q.qna_content,
            q.qna_created_date,
            q.qna_status,
            c.category_name
        FROM
            USER_QNA q
                INNER JOIN
            QNA_CATEGORY c ON q.category_no = c.category_no
        WHERE
            q.qna_no = #{qnaNo}
    </select>

    <!-- void insertQna(@Param("userNo") int userNo); -->

    <insert id="insertQna">
        INSERT INTO USER_QNA
        (QNA_TITLE, QNA_CONTENT, QNA_STATUS, QNA_CREATED_DATE, QNA_ISDELETED, QUESTION_USER_NO, CATEGORY_NO)
        VALUES
        (#{qna.qnaTitle}, #{qna.qnaContent}, 0, NOW(), 'N', #{qna.questionUserNo}, #{qna.categoryNo})
    </insert>

    <!-- void deleteQna(@Param("qnaNo") int qnaNo); -->

    <update id="deleteQna">
        UPDATE USER_QNA
        SET QNA_ISDELETED = 'Y', QNA_STATUS = 2
        WHERE QNA_NO = #{qnaNo}
    </update>

    <!-- void updateQna(@Param("qnaNo") int qnaNo, @Param("qna") QnaCreateRequest qnaCreateRequest); -->
    
    <update id="updateQna">
        UPDATE USER_QNA
        SET QNA_TITLE = #{qna.qnaTitle}, QNA_CONTENT = #{qna.qnaContent}, QNA_UPDATED_DATE = NOW(), CATEGORY_NO = #{qna.categoryNo}
        WHERE QNA_NO = #{qnaNo}
    </update>

    <!-- int getTotalRows(@Param("condition")Map<String, Object> condition); -->

    <select id="getTotalRows" resultType="int">
        select
            count(*) as cnt
        from
            USER_QNA uq
        where uq.QNA_ISDELETED = 'N'
        <if test="condition.category != null">
            and uq.qna_category_no = #{condition.category}
        </if>
        <if test="condition.opt != null">
            <choose>
                <when test="condition.opt == 'title'">
                    and uq.qna_title like concat('%', #{condition.keyword}, '%')
                </when>
                <when test="condition.opt == 'content'">
                    and uq.qna_content like concat('%', #{condition.keyword}, '%')
                </when>
            </choose>
        </if>
    </select>

    <!-- List<QnaResponse> getQnas(@Param("condition") Map<String, Object> condition); -->

    <select id="getQnas" resultType="store.seub2hu2.mypage.dto.QnaResponse">
        SELECT *
        FROM (
            SELECT
                <if test="condition.sort != null">
                    <choose>
                        <when test="condition.sort == 'date'">
                            row_number() over (order by  uq.qna_created_date desc ) rn
                        </when>
                        <otherwise>
                            row_number() over (order by uq.qna_no desc) rn
                        </otherwise>
                    </choose>
                </if>
            , uq.qna_no as qnaNo
            , uq.qna_title as qnaTitle
            , uq.qna_content as qnaContent
            , uq.qna_status as qnaStatus
            , uq.answer_content as answerContent
            , uq.answer_created_date as answerCreatedDate
            , uq.qna_created_date as qnaCreatedDate
            , uq.qna_updated_date as qnaUpdatedDate
            , uq.qna_answerd_date as qnaAnswerdDate
            , uq.qna_isdeleted as qnaIsDeleted
            , uq.question_user_no as questionUserNo
            , uq.category_no as categoryNo
            , uq.answer_user_no as answerUserNo
            from
                USER_QNA uq join QNA_CATEGORY qc
            on qc.category_no = uq.categoty_no
             )
    </select>

</mapper>
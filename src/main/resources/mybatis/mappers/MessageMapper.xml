<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.seub2hu2.message.mapper.MessageMapper">

    <!-- 메시지 삽입 -->
    <insert id="insertMessage" parameterType="store.seub2hu2.message.vo.Message">
        INSERT INTO MESSAGES (USER_NO, MESSAGE_TITLE, MESSAGE_CONTENT, MESSAGE_CREATED_DATE)
        VALUES (#{message.userNo}, #{message.title}, #{message.content}, NOW())
    </insert>

    <update id="deleteMessage" parameterType="store.seub2hu2.message.vo.Message">
        UPDATE MESSAGES
        SET MESSAGE_DELETE = 'Y'
        WHERE MESSAGE_NO = #{messageNo}
    </update>

    <update id="deleteMessages" parameterType="store.seub2hu2.message.vo.Message">
        UPDATE MESSAGES
        SET MESSAGE_DELETE = 'Y'
        WHERE MESSAGE_NO IN
        <foreach item="messageNo" collection="messageNos" open="(" separator="," close=")">
            #{messageNo}
        </foreach>
    </update>

    <update id="updateReceiveMessageReadStatus">
        UPDATE MESSAGE_RECEIVERS
        SET MESSAGE_READ      = 'Y',
            MESSAGE_READ_DATE = NOW()
        WHERE MESSAGE_NO = #{messageNo}
          AND USER_NO = #{userNo}
    </update>

    <update id="updateMessageReadStatus">
        UPDATE MESSAGES
        SET MESSAGE_READ      = 'Y'
        WHERE MESSAGE_NO = #{messageNo}
    </update>

    <update id="updateReadStatuses" parameterType="store.seub2hu2.message.dto.MessageReceived">
        UPDATE MESSAGE_RECEIVERS
        SET MESSAGE_READ = 'Y',
        MESSAGE_READ_DATE = NOW()
        WHERE MESSAGE_RCV_NO IN
        <foreach item="messageRcvNo" collection="messageRcvNos" open="(" separator="," close=")">
            #{messageRcvNo}
        </foreach>
    </update>


    <!-- 조건에 맞는 메시지 수 조회 -->
    <select id="getTotalRows" resultType="int">
        SELECT COUNT(*)
        FROM MESSAGES
        <where>
            <if test="condition.title != null">
                AND MESSAGE_TITLE LIKE CONCAT('%', #{condition.title}, '%')
            </if>
            <if test="condition.content != null">
                AND MESSAGE_CONTENT LIKE CONCAT('%', #{condition.content}, '%')
            </if>
            <if test="condition.keyword != null">
                AND (MESSAGE_TITLE LIKE CONCAT('%', #{condition.keyword}, '%')
                OR MESSAGE_CONTENT LIKE CONCAT('%', #{condition.keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 조건에 맞는 메시지 목록 조회 -->
    <select id="getMessages" resultType="store.seub2hu2.message.dto.MessageReceived">
        SELECT MESSAGE_NO AS messageNo, USER_NO AS userNo, MESSAGE_TITLE AS title,
        MESSAGE_CREATED_DATE AS createdDate, MESSAGE_UPDATED_DATE AS updatedDate, MESSAGE_DELETE AS deleted
        FROM MESSAGES
        <where>
            <if test="condition.title != null">
                AND MESSAGE_TITLE LIKE CONCAT('%', #{condition.title}, '%')
            </if>
            <if test="condition.content != null">
                AND MESSAGE_CONTENT LIKE CONCAT('%', #{condition.content}, '%')
            </if>
            <if test="condition.keyword != null">
                AND (MESSAGE_TITLE LIKE CONCAT('%', #{condition.keyword}, '%')
                OR MESSAGE_CONTENT LIKE CONCAT('%', #{condition.keyword}, '%'))
            </if>
            <!-- 조건 추가 가능 -->
        </where>
        <choose>
            <when test="condition.sort == 'desc'">
                ORDER BY MESSAGE_CREATED_DATE DESC
            </when>
            <otherwise>
                ORDER BY MESSAGE_CREATED_DATE ASC
            </otherwise>
        </choose>
        LIMIT #{condition.rows} OFFSET #{condition.offset}
    </select>

    <!-- 메시지 수신자 삽입 -->
    <insert id="insertMessageReceiver" parameterType="map">
        INSERT INTO MESSAGE_RECEIVERS (MESSAGE_NO, USER_NO)
        VALUES (#{messageNo}, #{userNo})
    </insert>

    <select id="getReceiverNickname" parameterType="int" resultType="string">
        SELECT nickname
        FROM users
        WHERE no = #{userNo}
    </select>


    <select id="getReceivedMessages" resultType="store.seub2hu2.message.dto.MessageReceived">
        SELECT
        m.MESSAGE_NO AS messageNo,
        m.USER_NO AS userNo,
        m.MESSAGE_TITLE AS title,
        m.MESSAGE_CREATED_DATE AS createdDate,
        m.MESSAGE_UPDATED_DATE AS updatedDate,
        m.MESSAGE_DELETE AS deleted,
        u.USER_NICKNAME AS senderNickname, -- 발신자 닉네임 추가
        r.MESSAGE_READ AS readStatus,
        r.MESSAGE_READ_DATE AS readDate
        FROM
        MESSAGES m
        JOIN MESSAGE_RECEIVERS r ON m.MESSAGE_NO = r.MESSAGE_NO
        JOIN USERS u ON m.USER_NO = u.USER_NO -- 발신자 정보 조회
        WHERE
        r.USER_NO = #{condition.userNo}
        AND m.MESSAGE_DELETE = 'N'
        <if test="condition.keyword != null and condition.opt != null">
            AND (
            <choose>
                <when test="condition.opt == 'title'">
                    m.MESSAGE_TITLE LIKE CONCAT('%', #{condition.keyword}, '%')
                </when>
                <when test="condition.opt == 'content'">
                    m.MESSAGE_CONTENT LIKE CONCAT('%', #{condition.keyword}, '%')
                </when>
                <when test="condition.opt == 'senderNickname'">
                    u.USER_NICKNAME LIKE CONCAT('%', #{condition.keyword}, '%')
                </when>
            </choose>
            )
        </if>
        <choose>
            <when test="condition.sort == 'desc'">
                ORDER BY MESSAGE_CREATED_DATE DESC
            </when>
            <otherwise>
                ORDER BY MESSAGE_CREATED_DATE ASC
            </otherwise>
        </choose>
        LIMIT #{condition.rows} OFFSET #{condition.offset}
    </select>

    <!-- 보낸 메시지 조회 -->
    <select id="getSentMessages"  resultType="store.seub2hu2.message.dto.MessageReceived">
        SELECT MESSAGE_NO AS messageNo,
        USER_NO AS userNo,
        MESSAGE_TITLE AS title,
        MESSAGE_CONTENT AS content,
        MESSAGE_CREATED_DATE AS createdDate,
        MESSAGE_UPDATED_DATE AS updatedDate,
        MESSAGE_DELETE AS deleted
        FROM MESSAGES
        WHERE USER_NO = #{condition.userNo}
        AND MESSAGE_DELETE = 'N'
        <if test="condition.keyword != null and condition.opt != null">
            AND (
            <choose>
                <when test="condition.opt == 'title'">
                    m.MESSAGE_TITLE LIKE CONCAT('%', #{condition.keyword}, '%')
                </when>
                <when test="condition.opt == 'content'">
                    m.MESSAGE_CONTENT LIKE CONCAT('%', #{condition.keyword}, '%')
                </when>
                <when test="condition.opt == 'senderNickname'">
                    u.USER_NICKNAME LIKE CONCAT('%', #{condition.keyword}, '%')
                </when>
            </choose>
            )
        </if>
        <choose>
            <when test="condition.sort == 'desc'">
                ORDER BY MESSAGE_CREATED_DATE DESC
            </when>
            <otherwise>
                ORDER BY MESSAGE_CREATED_DATE ASC
            </otherwise>
        </choose>
        LIMIT #{condition.rows} OFFSET #{condition.offset}
    </select>



    <!-- 메시지 상세 조회 -->
    <select id="getMessageDetailByNo" parameterType="int" resultType="store.seub2hu2.message.vo.Message">
        SELECT m.MESSAGE_NO           AS messageNo,
               m.MESSAGE_TITLE        AS title,
               m.MESSAGE_CONTENT      AS content,
               m.MESSAGE_CREATED_DATE AS createDate,
               m.MESSAGE_UPDATED_DATE AS updatedDate,
               u.USER_NICKNAME        AS senderNickname,
               m.MESSAGE_READ         AS readStatus-- 발신자 닉네임
        FROM MESSAGES m
                 JOIN USERS u ON m.USER_NO = u.USER_NO -- 발신자 정보
        WHERE m.MESSAGE_NO = #{messageNo}
    </select>
    <!-- 읽지 않은 메시지 개수 조회 -->
    <select id="countUnreadMessages" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM MESSAGE_RECEIVERS
        WHERE USER_NO = #{userNo}
          AND MESSAGE_READ = 'N'
    </select>


</mapper>




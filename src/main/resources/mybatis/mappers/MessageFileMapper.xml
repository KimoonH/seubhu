<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="store.seub2hu2.message.mapper.MessageMapper">

        <!-- 메시지 삽입 -->
        <insert id="insertMessage" parameterType="store.seub2hu2.message.vo.Message">
                INSERT INTO MESSAGES (user_no, title, content, created_date, updated_date, deleted)
                VALUES (#{userNo}, #{title}, #{content}, NOW(), NOW(), 'N')
        </insert>

        <!-- 메시지 업데이트 -->
        <update id="updateMessage" parameterType="store.seub2hu2.message.vo.Message">
                UPDATE MESSAGES
                SET deleted = #{deleted}, updated_date = NOW()
                WHERE message_no = #{messageNo}
        </update>

        <!-- 메시지 상세 조회 -->
        <select id="getMessageDetailByNo" parameterType="int" resultType="store.seub2hu2.message.vo.Message">
                SELECT * FROM MESSAGES
                WHERE message_no = #{messageNo} AND deleted = 'N'
        </select>

        <!-- 조건에 맞는 메시지 수 조회 -->
        <select id="getTotalRows" parameterType="map" resultType="int">
                SELECT COUNT(*) FROM MESSAGES
                WHERE deleted = 'N'
                <if test="opt != null and keyword != null">
                        AND ${opt} LIKE CONCAT('%', #{keyword}, '%')
                </if>
        </select>

        <!-- 조건에 맞는 메시지 목록 조회 -->
        <select id="getMessages" parameterType="map" resultType="store.seub2hu2.message.dto.MessageForm">
                SELECT message_no, user_no, title, content, created_date
                FROM MESSAGES
                WHERE deleted = 'N'
                <if test="opt != null and keyword != null">
                        AND ${opt} LIKE CONCAT('%', #{keyword}, '%')
                </if>
                ORDER BY created_date DESC
                LIMIT #{begin}, #{end}
        </select>

        <!-- 메시지 수신자 삽입 -->
        <insert id="insertMessageReceiver" parameterType="map">
                INSERT INTO MESSAGE_RECEIVERS (message_no, user_no)
                VALUES (#{messageNo}, #{userNo})
        </insert>

        <!-- 메시지 읽음 처리 -->
        <update id="markMessageAsRead" parameterType="map">
                UPDATE MESSAGE_RECEIVERS
                SET read_status = 'Y'
                WHERE message_no = #{messageNo} AND user_no = #{userNo}
        </update>

        <!-- 받은 메시지 목록 조회 -->
        <select id="getReceivedMessages" parameterType="map" resultType="store.seub2hu2.message.vo.Message">
                SELECT m.message_no, m.user_no, m.title, m.content, m.created_date
                FROM MESSAGES m
                INNER JOIN MESSAGE_RECEIVERS mr ON m.message_no = mr.message_no
                WHERE mr.user_no = #{userNo} AND m.deleted = 'N'
                <if test="opt != null and keyword != null">
                        AND m.${opt} LIKE CONCAT('%', #{keyword}, '%')
                </if>
                ORDER BY m.created_date DESC
                LIMIT #{begin}, #{end}
        </select>

        <!-- 보낸 메시지 목록 조회 -->
        <select id="getSentMessages" parameterType="map" resultType="store.seub2hu2.message.vo.Message">
                SELECT message_no, user_no, title, content, created_date
                FROM MESSAGES
                WHERE user_no = #{userNo} AND deleted = 'N'
                ORDER BY created_date DESC
                        LIMIT #{begin}, #{end}
        </select>

</mapper>

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="store.seub2hu2.product.mapper.ProductMapper">

    <!--
    int getTotalRows(@Param("condition") Map<String, Object> condition);
    -->

    <select id="getTotalRows" resultType="int">
        select
        count(*) as cnt
        from
        PRODUCTS P
        <if test="condition.topNo != null and condition.topNo != ''">
            JOIN PROD_CATEGORIES PC ON P.CAT_NO = PC.CAT_NO
        </if>
        <where>
            <if test="condition != null">
                <choose>
                    <when test="condition.opt == 'name'">
                        AND P.PROD_NAME LIKE '%' || #{condition.value} || '%'
                    </when>
                    <when test="condition.opt == 'minPrice'">
                        AND P.PROD_PRICE >= #{condition.value}
                    </when>
                    <when test="condition.opt == 'maxPrice'">
                        AND P.PROD_PRICE &lt;= #{condition.value}
                    </when>
                </choose>
            </if>
            <if test="condition.topNo != null and condition.topNo != ''">
                AND PC.TOP_CAT_NO IN (#{condition.topNo}, 30)
            </if>
        </where>
    </select>

    <!--
        List<ProdListDto> getProducts();
    -->
    <select id="getProducts" resultType="store.seub2hu2.product.dto.ProdListDto">
        SELECT *
        FROM(
            SELECT
                <choose>
                    <when test="condition.sort == 'date'">
                        ROW_NUMBER() OVER(ORDER BY P.PROD_CREATED_AT DESC) AS RN
                    </when>
                    <when test="condition.sort == 'name'">
                        ROW_NUMBER() OVER(ORDER BY P.PROD_NAME ASC) AS RN
                    </when>
                    <when test="condition.sort == 'price'">
                        ROW_NUMBER() OVER(ORDER BY P.PROD_PRICE ASC) AS RN
                    </when>
                </choose>
            , P.PROD_NO AS NO,
            P.PROD_NAME AS NAME,
            P.PROD_PRICE AS PRICE,
            P.PROD_STATUS AS STATUS,
            P.PROD_CREATED_AT AS CREATEDAT,
            P.PROD_IMG_THUM AS IMGTHUM,
            PC.CAT_NO AS "CATEGORY.NO",
            PC.CAT_NAME AS "CATEGORY.NAME",
            PB.BRAND_NAME AS "BRAND.NAME"
            FROM PRODUCTS P
                JOIN PROD_CATEGORIES PC ON P.CAT_NO = PC.CAT_NO
                JOIN PROD_BRANDS PB ON P.BRAND_NO = PB.BRAND_NO
            <if test="condition != null">
                <choose>
                    <when test="condition.opt == 'name'">
                        AND P.PROD_NAME LIKE CONCAT ('%', #{condition.value},'%')
                    </when>
                    <when test="condition.opt == 'minPrice'">
                        AND P.PROD_PRICE >= #{condition.value}
                    </when>
                    <when test="condition.opt == 'maxPrice'">
                        AND P.PROD_PRICE &lt;= #{condition.value}
                    </when>
                </choose>
            </if>
            <if test="condition.topNo != null and condition.topNo != ''">
                AND PC.TOP_CAT_NO IN (#{condition.topNo}, 30)
            </if>
            <if test="condition.catNo != null and condition.catNo != ''">
                AND PC.CAT_NO IN (#{condition.catNo})
            </if>
            ) AS subquery
        WHERE
            RN BETWEEN #{condition.begin} AND #{condition.end}
    </select>
</mapper>